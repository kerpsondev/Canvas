#!/bin/ash
# Paper Installation Script
#
# Server Files: /mnt/server

PROJECT="Canvas"

if [ -n "${DL_PATH}" ]; then
    echo "Using supplied download URL: ${DL_PATH}"
    DOWNLOAD_URL=$(eval echo "${DL_PATH}" | sed -e 's/{{/${/g' -e 's/}}/}/g')
else
    LATEST_BUILD=$(curl -s "https://jenkins.canvasmc.io/job/Canvas/lastSuccessfulBuild/api/json" | jq -r '.number')
    
    if [ "${BUILD_NUMBER}" = "latest" ] || [ -z "${BUILD_NUMBER}" ]; then
        BUILD_NUMBER=${LATEST_BUILD}
        echo "Using latest build: ${BUILD_NUMBER}"
    fi
    
    JAR_NAME=$(curl -s "https://jenkins.canvasmc.io/job/Canvas/${BUILD_NUMBER}/api/json" | jq -r '.artifacts[].fileName' | grep -Eo 'canvas-.*\.jar' | head -n 1)
    
    if [ -z "${JAR_NAME}" ]; then
        echo "Failed to retrieve JAR file name. Exiting."
        exit 1
    fi
    
    echo "Version being downloaded:"
    echo "Build: ${BUILD_NUMBER}"
    echo "JAR Name of Build: ${JAR_NAME}"
    DOWNLOAD_URL="https://jenkins.canvasmc.io/job/Canvas/${BUILD_NUMBER}/artifact/canvas-server/build/libs/${JAR_NAME}"
fi

cd /mnt/server || { echo "Failed to change directory to /mnt/server"; exit 1; }

if [ -z "${SERVER_JARFILE}" ]; then
    echo "SERVER_JARFILE is not set. Exiting."
    exit 1
fi

echo "Running curl -o ${SERVER_JARFILE} ${DOWNLOAD_URL}"

if [ -f "${SERVER_JARFILE}" ]; then
    mv "${SERVER_JARFILE}" "${SERVER_JARFILE}.old"
fi

curl -f -o "${SERVER_JARFILE}" "${DOWNLOAD_URL}" || { echo "Download failed. Exiting."; exit 1; }

# Sprawdzanie, czy plik JAR jest prawid≈Çowy
if ! file "${SERVER_JARFILE}" | grep -q "Java archive"; then
    echo "Downloaded file is not a valid JAR. Exiting."
    exit 1
fi

if [ ! -f "server.properties" ]; then
    echo "Downloading MC server.properties"
    curl -o "server.properties" "https://raw.githubusercontent.com/parkervcp/eggs/master/minecraft/java/server.properties" || echo "Failed to download server.properties"
fi
